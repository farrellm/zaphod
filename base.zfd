(def car
     (forall a (-> (cons a ()) Top))
     (unsafe-coerce fst))

(def cdr (forall a (-> (cons a ()) Top))
     (unsafe-coerce snd))

(def tuple'
     (-> (cons Top ()) Top)
     (lambda (t)
       (if (is-nil t) (: () Top)
           (cons 'cons
                 (cons (car t)
                       (cons (tuple' (cdr t))
                             ()))))))

(def tuple
     (-> Top Top)
     (macro t (tuple' t)))

(def defn
     (-> [(Symbol . Top) Type Top] Top)
     (macro (p t e)
       ['def (car p) t ['lambda (cdr p) e]]))

(defn (forall' us e)
  (-> [Top Top] Top)
  (if (is-symbol us)
      (: ['forall us e] Top)
      (if (is-nil us)
          e
          ['forall (car us) (forall' (cdr us) e)])))

(def forall
     (-> [Top Top] Top)
     (macro (us e) (forall' us e)))

(defn (compose f g)
  (forall (a b c)
          (-> [(-> [b] c) (-> [a] b)]
              (-> [a] c)))
  (lambda (x) (f (g x))))

(def caar (compose car car))
(def cadr (compose car cdr))
(def cdar (compose cdr car))
(def cddr (compose cdr cdr))
(def caddr (compose car cddr))

(defn (let1 x v e)
  (-> [Top Top Top] Top)
  [['lambda [x] e] v])

(defn (let' ps e)
  (-> [Top Top] Top)
  (if (is-nil ps) e
      (let1 (car (car ps))
            (cadr (car ps))
            (let' (cdr ps) e))))

(def let
     (-> [Top Top] Top)
     (macro (ps e) (let' ps e)))

(defn (foralls xs e)
  (-> [Top Top] Top)
  (if (is-nil xs)
      e
      ['forall (car xs) (foralls (cdr xs) e)]))

(defn (gen-syms xs)
  (-> [Top] Top)
  (if (is-nil xs) (: () Top)
      (cons (unsafe-gensym) (gen-syms (cdr xs)))))

(defn (constructor n xs c)
  (-> [Symbol Top Top] Top)
  (if (is-symbol c)
      (: ['def c
               (foralls xs (cons n xs))
               ['unsafe-coerce ['quote c]]]
         Top)
      (let ((c' (cons (car c) (gen-syms (cdr c)))))
        ['defn c'
          (foralls xs ['-> (cons 'tuple (cdr c)) (cons n xs)])
          ['unsafe-coerce (cons 'tuple (cons ['quote (car c')] (cdr c')))]])))

(defn (constructors n xs cs)
  (-> [Symbol Top Top] Top)
  (if (is-nil cs)
      (: () Top)
      (cons
       (constructor n xs (car cs))
       (constructors n xs (cdr cs)))))

(defn (data' n xs cs)
  (-> [Symbol Top Top] Top)
  (cons
   'begin
   (cons
    ['def n ['lambda xs [': (cons 'tuple (cons ['quote n] xs)) 'Type]]]
    (constructors n xs cs))))

(def data
     (-> ((Symbol . Top) . Top) Top)
     (macro d (data' (fst (fst d)) (cdar d) (cdr d))))


(defn (cond' cs)
  (-> [Top] Top)
  (if (is-nil cs)
      (: () Top)
      (let ((c (car cs))
            (cs' (cdr cs)))
        (if (is-symbol (car c))
            (cadr c)
            ['if (car c) (cadr c) (cond' cs')]))))

(def cond
     (-> Top Top)
     (macro cs (cond' cs)))
